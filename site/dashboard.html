<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Playniti — Dashboard</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script defer src="config/config.js"></script>
</head>
<body>
  <div class="container">
    <div class="nav">
      <a href="index.html"><strong>← Playniti</strong></a>
      <div id="authArea">
        <button class="btn" onclick="showLogin()">Login / Sign up</button>
      </div>
    </div>

    <div class="grid" style="grid-template-columns:2fr 1fr;gap:20px">
      <div>
        <div class="card">
          <h2>Wallet</h2>
          <div id="wallet">
            <p><strong>Balance:</strong> <span id="balance">—</span> NC</p>
            <div style="display:flex; gap:10px;flex-wrap:wrap">
              <button class="btn" onclick="openAddNC()">Add NC (QR)</button>
              <button class="btn" style="background:#1a2a48" onclick="openWithdraw()">Withdraw</button>
            </div>
          </div>
        </div>

        <div class="card" id="historyCard">
          <h3>Recent Activity</h3>
          <table class="table" id="ledgerTable">
            <thead><tr><th>When</th><th>Type</th><th>Amount</th><th>Note</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Quick Links</h3>
          <p><a href="game.html">Play Sarp Niti (Demo)</a></p>
          <p><a href="#wallet">Add NC</a></p>
          <p><a href="#">Join official lobby (coming soon)</a></p>
        </div>
        <div class="card">
          <h3>Profile</h3>
          <div id="profile"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add NC Modal -->
  <div id="addNcModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5)">
    <div class="card" style="max-width:520px;margin:40px auto">
      <h3>Add Niti Coins (QR)</h3>
      <div id="qrOptions"></div>
      <div class="hr"></div>
      <label class="label">Amount (NC)</label>
      <input class="input" id="depAmount" placeholder="e.g., 200">
      <label class="label">UPI Ref / Transaction ID</label>
      <input class="input" id="depRef" placeholder="e.g., 3245XXXXXX">
      <label class="label">Upload Screenshot</label>
      <input class="input" type="file" id="depFile" accept="image/*">
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn" onclick="submitDeposit()">Submit</button>
        <button class="btn" style="background:#1a2a48" onclick="closeAddNC()">Close</button>
      </div>
      <small>Admin will verify and credit NC shortly.</small>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div id="wdModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5)">
    <div class="card" style="max-width:520px;margin:40px auto">
      <h3>Withdraw</h3>
      <label class="label">Amount (NC)</label>
      <input class="input" id="wdAmount" placeholder="e.g., 150">
      <label class="label">UPI ID</label>
      <input class="input" id="wdUpi" placeholder="name@upi">
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn" onclick="submitWithdraw()">Request</button>
        <button class="btn" style="background:#1a2a48" onclick="closeWithdraw()">Close</button>
      </div>
      <small>Admin will process UPI transfer manually.</small>
    </div>
  </div>

<script>
let app, auth, db, storage, userDocRef, userDocSnap, adminEmail;

function init() {
  const cfg = window.PLAYNITI_CONFIG;
  if (!cfg) { alert('Missing config.js'); return; }
  adminEmail = cfg.adminEmail;
  app = firebase.initializeApp(cfg.firebase);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();

  auth.onAuthStateChanged(async (u) => {
    const el = document.getElementById('authArea');
    if (!u) {
      el.innerHTML = '<button class="btn" onclick="showLogin()">Login / Sign up</button>';
      document.getElementById('balance').textContent = '—';
      document.querySelector('#ledgerTable tbody').innerHTML = '';
      document.getElementById('profile').innerHTML = '';
      return;
    }
    el.innerHTML = '<small>'+u.email+'</small> <button class="btn" style="background:#1a2a48" onclick="logout()">Logout</button>';
    userDocRef = db.collection('users').doc(u.uid);
    const snap = await userDocRef.get();
    if (!snap.exists) {
      await userDocRef.set({ email: u.email, balance_nc: 0, created_at: firebase.firestore.FieldValue.serverTimestamp() });
    }
    loadProfile();
    loadLedger();
  });

  // Populate QR options
  const qrWrap = document.getElementById('qrOptions');
  qrWrap.innerHTML = '';
  (window.PLAYNITI_CONFIG.qrUPI?.options || []).forEach(o => {
    qrWrap.innerHTML += '<div class="card" style="display:flex;gap:12px;align-items:center"><img src="'+o.img+'" width="100"><div><strong>'+o.label+'</strong><br><small>Scan & pay, then submit proof below.</small></div></div>';
  });
}

async function loadProfile() {
  const u = auth.currentUser;
  if (!u) return;
  const d = await userDocRef.get();
  const data = d.data();
  document.getElementById('balance').textContent = (data.balance_nc ?? 0).toFixed(2);
  document.getElementById('profile').innerHTML = '<div><strong>'+ (u.email||'') +'</strong><br><small>UID: '+u.uid+'</small></div>';
}

async function loadLedger() {
  const u = auth.currentUser; if (!u) return;
  const q = await db.collection('ledger').where('uid','==',u.uid).orderBy('created_at','desc').limit(20).get();
  const tbody = document.querySelector('#ledgerTable tbody'); tbody.innerHTML='';
  q.forEach(doc => {
    const r = doc.data();
    const when = r.created_at?.toDate ? r.created_at.toDate().toLocaleString() : '';
    tbody.innerHTML += '<tr><td>'+when+'</td><td>'+r.type+'</td><td>'+r.amount_nc+'</td><td>'+ (r.note||'') +'</td></tr>';
  });
}

function showLogin(){
  const email = prompt('Email:');
  if(!email) return;
  const pass = prompt('Password (create new if no account):');
  if(!pass) return;
  auth.signInWithEmailAndPassword(email, pass).catch(async e => {
    if (e.code === 'auth/user-not-found') {
      await auth.createUserWithEmailAndPassword(email, pass);
    } else {
      alert(e.message);
    }
  });
}
function logout(){ auth.signOut(); }

function openAddNC(){ document.getElementById('addNcModal').style.display='block'; }
function closeAddNC(){ document.getElementById('addNcModal').style.display='none'; }
function openWithdraw(){ document.getElementById('wdModal').style.display='block'; }
function closeWithdraw(){ document.getElementById('wdModal').style.display='none'; }

async function submitDeposit(){
  const u = auth.currentUser; if(!u) return alert('Login first');
  const amount = parseFloat(document.getElementById('depAmount').value||'0');
  const ref = document.getElementById('depRef').value.trim();
  const file = document.getElementById('depFile').files[0];
  if(amount<=0 || !ref || !file) return alert('Fill amount, ref and screenshot');
  const path = `deposit_proofs/${u.uid}/${Date.now()}_${file.name}`;
  const snap = await storage.ref().child(path).put(file);
  const url = await snap.ref.getDownloadURL();
  await db.collection('deposit_requests').add({
    uid: u.uid, email: u.email, amount_nc: amount, ref_id: ref, screenshot_url: url,
    status: 'PENDING', created_at: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert('Submitted. Admin will verify shortly.');
  closeAddNC();
}

async function submitWithdraw(){
  const u = auth.currentUser; if(!u) return alert('Login first');
  const amount = parseFloat(document.getElementById('wdAmount').value||'0');
  const upi = document.getElementById('wdUpi').value.trim();
  if(amount<=0 || !upi) return alert('Fill amount and UPI ID');
  await db.collection('withdrawal_requests').add({
    uid: u.uid, email: u.email, amount_nc: amount, upi_id: upi,
    status: 'PENDING', created_at: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert('Withdrawal requested. Admin will process via UPI.');
  closeWithdraw();
}

window.addEventListener('load', init);
</script>
</body>
</html>
