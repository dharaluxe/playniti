<script>
let sb, user, adminEmail;

async function init() {
  const cfg = window.PLAYNITI_SUPABASE;   // <- use your supabase config
  if (!cfg) { alert('Missing config.js'); return; }

  adminEmail = cfg.adminEmail;
  sb = supabase.createClient(cfg.url, cfg.anonKey);

  // auth state
  const { data: { user: u } } = await sb.auth.getUser();
  user = u;
  renderAuth();

  // load data if logged in
  if (user) {
    await ensureProfile();
    await loadProfile();
    await loadLedger();
  }
}

function renderAuth() {
  const el = document.getElementById('authArea');
  if (!user) {
    el.innerHTML = '<button class="btn" onclick="showLogin()">Login / Sign up</button>';
  } else {
    el.innerHTML = `<small>${user.email||''}</small>
      <button class="btn" style="background:#1a2a48" onclick="logout()">Logout</button>`;
  }
}

async function ensureProfile() {
  await sb.from('profiles')
    .upsert([{ id: user.id, email: user.email }], { onConflict: 'id' });
}

async function loadProfile() {
  const { data } = await sb.from('profiles').select('balance_nc').eq('id', user.id).single();
  document.getElementById('balance').textContent = ((data?.balance_nc)||0).toFixed(2);
  document.getElementById('profile').innerHTML =
    `<div><strong>${user.email||''}</strong><br><small>UID: ${user.id}</small></div>`;
}

async function loadLedger() {
  const { data } = await sb.from('ledger')
    .select('created_at,type,amount_nc,note')
    .eq('user_id', user.id)
    .order('created_at', { ascending:false })
    .limit(20);
  const tbody = document.querySelector('#ledgerTable tbody');
  tbody.innerHTML = '';
  (data||[]).forEach(r => {
    const when = r.created_at ? new Date(r.created_at).toLocaleString() : '';
    tbody.innerHTML += `<tr><td>${when}</td><td>${r.type}</td><td>${r.amount_nc}</td><td>${r.note||''}</td></tr>`;
  });
}

async function showLogin(){
  const email = prompt('Email:'); if (!email) return;
  const pass  = prompt('Password (new users can create here):'); if (!pass) return;

  let { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error && error.message.includes('Invalid login')) {
    // try sign up
    const res = await sb.auth.signUp({ email, password: pass });
    if (res.error) return alert(res.error.message);
    data = res.data;
  } else if (error) {
    return alert(error.message);
  }
  user = data.user;
  renderAuth();
  await ensureProfile();
  await loadProfile();
  await loadLedger();
}

async function logout(){
  await sb.auth.signOut();
  user = null;
  renderAuth();
  document.getElementById('balance').textContent = 'â€”';
  document.querySelector('#ledgerTable tbody').innerHTML = '';
  document.getElementById('profile').innerHTML = '';
}

function openAddNC(){ document.getElementById('addNcModal').style.display='block'; }
function closeAddNC(){ document.getElementById('addNcModal').style.display='none'; }
function openWithdraw(){ document.getElementById('wdModal').style.display='block'; }
function closeWithdraw(){ document.getElementById('wdModal').style.display='none'; }

async function submitDeposit(){
  if (!user) return alert('Login first');
  const amount = parseFloat(document.getElementById('depAmount').value||'0');
  const ref    = document.getElementById('depRef').value.trim();
  const file   = document.getElementById('depFile').files[0];
  if (amount<=0 || !ref || !file) return alert('Fill amount, ref and screenshot');

  // upload to Supabase Storage (create a public bucket named "proofs" once)
  const path = `${user.id}/${Date.now()}_${file.name}`;
  const up = await sb.storage.from('proofs').upload(path, file, { upsert:false });
  if (up.error) return alert(up.error.message);
  const { data: pub } = sb.storage.from('proofs').getPublicUrl(path);

  const { error } = await sb.from('deposit_requests').insert({
    user_id: user.id, email: user.email, amount_nc: amount,
    ref_id: ref, screenshot_url: pub.publicUrl, status: 'PENDING'
  });
  if (error) return alert(error.message);
  alert('Submitted. Admin will verify shortly.'); closeAddNC();
}

async function submitWithdraw(){
  if (!user) return alert('Login first');
  const amount = parseFloat(document.getElementById('wdAmount').value||'0');
  const upi    = document.getElementById('wdUpi').value.trim();
  if (amount<=0 || !upi) return alert('Fill amount and UPI ID');

  const { error } = await sb.from('withdrawal_requests').insert({
    user_id: user.id, email: user.email, amount_nc: amount, upi_id: upi, status: 'PENDING'
  });
  if (error) return alert(error.message);
  alert('Withdrawal requested. Admin will process via UPI.'); closeWithdraw();
}

window.addEventListener('load', init);
</script>
